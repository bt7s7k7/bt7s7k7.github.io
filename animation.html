<!DOCTYPE html>
<html>
	<head>
		<script src="stuff/bUtils.js"></script>
		<script src="stuff/canvas.js"></script>
		<script src="stuff/paint.js"></script>
		<link rel="stylesheet" type="text/css" href="stuff/btStyle.css">
		<script>
			var paint
			var empty
			var notOften = 0
			var playing = false
			var playFrame = 0
			
			var sizeButton = 0
			const sizes = [6,12,24];
			
			var toolButton = 0;
			var tools
			
			var keyframes = []
			var frameId = 1
			function setup() {
				ctx = new CanvasUtil(B.canvas)
				paint = new Painter(ctx)
				paint.style.width = 6
				tools = [brushes.normal,brushes.eraser];
				keyframes.push(ctx.toDataUrl())
				empty = ctx.toDataUrl()
				updateFramepanel()
			}
			
			function update() {
				if (paint.down) {
					document.body.style.backgroundColor = "#eeeeee"
				} else {
					document.body.style.backgroundColor = "#ffffff"
				}
				[E.size1,E.size2,E.size3].forEach((v,i)=>{
					if (i == sizeButton) {
						v.style.backgroundColor = "#00ff00"
					} else {
						v.style.backgroundColor = "#ffffff"
					}
				})
				paint.style.width = sizes[sizeButton];
				[E.tool1,E.tool2].forEach((v,i)=>{
					if (i == toolButton) {
						v.style.backgroundColor = "#00ff00"
					} else {
						v.style.backgroundColor = "#ffffff"
					}
				})
				paint.style.brush = tools[toolButton]
				
				frameInd.innerText = (frameId) + " / " + keyframes.length
				
				notOften++
				if (notOften == 60) {
					keyframes[frameId - 1] = ctx.toDataUrl()
					updateFramepanel()
					notOften = 0
				}
				E.playButt.style.backgroundColor = (playing) ? "#00ff00" : "#ffffff"
				E.playFrame.innerText = (playFrame + 1) + " / " + keyframes.length
				if (notOften % 10 == 0) {
					E.player.src = keyframes[playFrame]
					if (playing) {
						playFrame++
						playFrame = playFrame.overflow(0,keyframes.length - 1)
						updateFramepanel()
					}
				}
			}
			
			function moveSelection(off,effect) {
				if (effect == 0) {
					keyframes[frameId - 1] = ctx.toDataUrl()
					
					frameId += off
					frameId = frameId.overflow(1,keyframes.length)
					
					ctx.clear()
					ctx.load(keyframes[frameId - 1])
					E.back.src = keyframes[(frameId - 1).overflow(1,keyframes.length) - 1]
				} else if (effect == 1) {
					keyframes.splice((frameId - 1 + off).overflow(1,keyframes.length + 1),0,empty)
					moveSelection(off,0)
				} else if (effect == 2) {
					keyframes.splice((frameId - 1 + off).overflow(1,keyframes.length + 1),1)
					if (off == -1) {
						moveSelection(off,0)
					}
				}
				updateFramepanel()
			}
			
			function updateFramepanel() {
				var panel = E.framePanel
				panel.innerHTML = ""
				keyframes.forEach((v,i)=>{
					var img = document.createElement("img")
					img.src = v
					img.style.height = "100px"
					img.style.width = "100px"
					img.style.border = (i == frameId - 1) ? "2px solid #00ff00" : ((i == playFrame) ? "2px solid red" : "2px solid black")
					img.style.position = "absolute"
					img.style.top = "0px"
					img.style.left = i * 104 + "px"
					img.addEventListener("mousedown",(event)=>{
						if (event.button == 0) {
							moveSelection(i + 1 - frameId,0)
						} else if (event.button == 1) {
							clearFrame()
							ctx.load(keyframes[i])
							keyframes[frameId - 1] = ctx.toDataUrl()
							updateFramepanel()
						}
					})
					panel.appendChild(img)
				})
			}
			
			function clearFrame() {
				ctx.clear()
				keyframes[frameId - 1] = ctx.toDataUrl()
				updateFramepanel()
			}
			
			function cloneFrame() {
				moveSelection(1,1)
				ctx.load(keyframes[
					(frameId - 2).overflow(0,keyframes.length)
				])
			}
			function exportF() {
				E.io.value = JSON.stringify(keyframes)
				updateFramepanel()
			}
			function importF() {
				keyframes = JSON.parse(E.io.value)
				playFrame = 0
				frameId = 1;
				
				ctx.clear()
				ctx.load(keyframes[frameId - 1])
				E.back.src = keyframes[(frameId - 1).overflow(1,keyframes.length) - 1]
				updateFramepanel()
			}
			
			function moveMovie(off) {
				playFrame = (playFrame + off).overflow(0,keyframes.length -1)
				E.player.src = keyframes[playFrame]
				updateFramepanel()
			}
		</script>
	</head>
	<body>
		<div style="position:absolute;top:8px;left:8px;background-color:#ffffff" class="S500x500"></div>
		<img class="border S500x500 pixelate" style="position:absolute;top:8;left:8" id="back" height="500" width="500"></img>
		<div style="position:absolute;top:8px;left:8px;background-color:#ffffff;opacity:0.5" class="S500x500"></div>
		<canvas class="border S500x500 pixelate" style="position:absolute;top:8px;left:8px;cursor:crosshair" id="main" height="500" width="500">
		</canvas>
		
		<div style="position:absolute;top:516px;left:8px">
			<button id="size1" onclick="sizeButton = 0" style="font-size:20px;height:40px;width:40px">●</button>
			<button id="size2" onclick="sizeButton = 1" style="font-size:30px;height:40px;width:40px;position:relative;top:4px">●</button>
			<button id="size3" onclick="sizeButton = 2" style="font-size:40px;height:40px;width:40px;position:relative;top:13px">
				<span style="position:relative;bottom:6px">●</span>
			</button>
			<br />
			<button id="tool1" onclick="toolButton = 0" style="font-size:40px;height:40px;width:40px;position:relative;top:13px">
				<span style="position:relative;bottom:8px">■</span>
			</button>
			<button id="tool2" onclick="toolButton = 1" style="font-size:40px;height:40px;width:40px;position:relative;top:13px">
				<span style="position:relative;bottom:8px">□</span>
			</button>
		</div>
		
		<div style="position:absolute;top:536px;left:208px;text-align:center">
			<span id="frameInd">0 / 0</span>
			<br />
			<button onclick="moveSelection(-1,0)" ><</button>
			<button onclick="moveSelection(1,0)" >></button>
			<br />
			<button onclick="moveSelection(-1,1)" >+ <</button>
			<button onclick="moveSelection(1,1)" >> +</button>
			<br />
			<button onclick="moveSelection(-1,2)" >- <</button>
			<button onclick="moveSelection(1,2)" >> -</button>
			<br />
			<button onclick="clearFrame()">Clear</button>
			<br />
			<button onclick="cloneFrame()">Clone</button>
		</div>
		
		<div style="overflow-x:auto;overflow-y:hidden;position:absolute;
		top:530px;left:300px;height:120px;width:700px" id="framePanel"></div>
		
		<img class="border S500x500 pixelate" style="position:absolute;top:8px;left:616px" id="player" height="500" width="500"></img>
		<div style="position:absolute;top:8px;left:516px">
			<button id="playButt" onclick="playing = !playing">►</button>
			<span id="playFrame">0</span><br />
			<button onclick="moveMovie(-1)"><</button>
			<button onclick="moveMovie(1)">></button>
		</div>
		
		<div style="position:absolute;left:8px;top:700px">
			<button onclick="importF()">Import</button><br />
			<button onclick="exportF()">Export</button>
		</div>
		<textarea style="position:absolute;left:70px;top:700px;resize:none;height:100px;width:700px" id="io"></textarea>
	</body>
</html>